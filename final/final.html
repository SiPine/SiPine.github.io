<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8">
    <title>
        Object recognition results of multiple images
    </title>
    <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-zoom.v1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script src="bootstrap-table-master/dist/bootstrap-table.js"></script>
    <link href="bootstrap-table-master/dist/bootstrap-table.css" rel="stylesheet" />

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://kit.fontawesome.com/1ad6753a8b.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/fontawesome.css"
          integrity="sha384-4aon80D8rXCGx9ayDt85LbyUHeMWd3UiBaWliBlJ53yzm9hqN21A+o1pqoyK04h+" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/brands.css"
          integrity="sha384-BKw0P+CQz9xmby+uplDwp82Py8x1xtYPK3ORn/ZSoe6Dk3ETP59WCDnX+fI1XCKK" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <div class="wrapper">
        <header>
            <div id="header-title-wrapper" style="width: 500px;">
                <div>
                    <div id="header-title" style="width: 200px;">object recognition</div>
                </div>
            </div>
            <div class="header-content">
                <span id="dataset-name" class="smalltext-header">dataset</span>
                <div class="btn-group">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                        set1
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="#">set2</a>
                        </li>
                        <li>
                            <a href="#">set3</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="header-content">
                <span class="smalltext-header">model1</span>
                <div id="model-name" class="header-value">VGG16</div>
            </div>
            <div class="header-content">
                <span class="smalltext-header">model2</span>
                <div id="model-name" class="header-value">ResNet</div>
            </div>
            <div class="header-content">
                <span id="classes-name" class="smalltext-header">classes</span>
                <div id="classes-value" class="header-value">30</div>
            </div>

            <div class="header-content">
                <span id="instances-name" class="smalltext-header">instances</span>
                <div id="instances-value" class="header-value">300</div>
            </div>

        </header>

        <div id="main" >
            <div id="left">
                <div id="left-inner">
                    <div id="neighbor" class="row clearfix">
                    </div>                      
                    <div id="left-inner-class-bar-wrapper" style="overflow:scroll; width:400px; height:450px;">
                        <div id="toolbar">
                            <button onclick="reset()">Reset</button>
                        </div>
                        <table id="table1" class="table table-bordered"></table>
                    </div>    
                </div>
            </div>
            <div id="middle">
                <div id="middle_thumb" ></div>
            </div>
            <div id="right">
                <div id="right-inner1" style="overflow:scroll;">                          
                </div>
            </div>
        </div>   
    </div>
    <script type="text/javascript">
        d3.json("result_version_2.json", function (error, data) {

            var tsne_svg = d3.select("#neighbor")
                .append("svg")
                .attr("width", 430)
                .attr("height", 400)

            var zoom = d3.zoom()
                .on("zoom", zoomed);

            tsne_svg.call(zoom);

            var x, y, s;

            var tsne_svg_width = tsne_svg.attr("width");
            var tsne_svg_height = tsne_svg.attr("height");

            var x_max = d3.max(data, function (d) { return parseFloat(d.view_X); });
            var x_min = d3.min(data, function (d) { return parseFloat(d.view_X); });
            var y_max = d3.max(data, function (d) { return parseFloat(d.view_Y); });
            var y_min = d3.min(data, function (d) { return parseFloat(d.view_Y); });

            var padding = 20

            var xScale = d3.scaleLinear()
                .domain([x_min, x_max])
                .range([padding, tsne_svg_width - padding-30]);

            var yScale = d3.scaleLinear()
                .domain([y_min, y_max])
                .range([padding, tsne_svg_height - padding]);

            // color for each class
            var color = d3.scaleSequential()
                .domain([0, 30])
                .interpolator(d3.interpolateRainbow); // color(i) returns rgb hex

            var text = tsne_svg.append("g")
                .attr("id", "text");

            /*var logoUrl = 'new_umap_image/n01685808_102.JPEG';

            //SVG Setup stuff
            var svg = d3.select("#middle_thumb").append("svg")
                .attr('id', 'mySVG')
                .attr("width", "100%")
                .attr("height", "100%")

            var svg_img = svg.append('image')
                .attr('image-rendering', 'optimizeQuality')
                .attr('x', '0')
                .attr('y', '0');

            //Load image and get size.
            var img = new Image();
            img.src = logoUrl;
            img.onload = function () {
                var width = this.width;
                var height = this.height;

                svg_img.attr('height', height)
                    .attr('width', width)
                    .attr('xlink:href', logoUrl)

            }*/

            var circles = tsne_svg
                .append("g")
                .attr("id", "plot")
                .selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("id", d => `circle_${d.picture_imageNet_ID}`)
                .attr("cx", d => xScale(parseFloat(d.view_X)))
                .attr("cy", d => yScale(parseFloat(d.view_Y)))
                .attr("r", 4)
                .attr("fill", d => color(parseInt(d.color_ID)))
                .on("mouseover", d => {

                    for (var k = 0; k < data.length; ++k) {
                        var ids = data[k].picture_imageNet_ID;
                        var each_circle = d3.select(`#circle_${ids}`);
                        var fill = d3.color(each_circle.attr("fill"));
                        fill.opacity = 0.3;
                        each_circle.transition()
                            .duration(1000)
                            .attr("fill", fill)
                    }

                    for (var i = 0; i < data.length; i++) {
                        var label = data[i].true_label;
                        if (label == d.true_label) {
                            id = data[i].picture_imageNet_ID;
                            var text_x = d3.select(`#circle_${id}`).attr("cx");
                            var text_y = d3.select(`#circle_${id}`).attr("cy");
                            d3.select(`#circle_${id}`)
                                .transition()
                                .attr("r", 8)
                                .attr("fill", color(parseInt(d.color_ID)));
                            text.append("text")
                                .text(data[i].true_label)
                                .attr("id", `test_${data[i].picture_imageNet_ID}`)
                                .attr("x", text_x)
                                .attr("y", text_y)
                                .attr("font-family", "sans-serif")
                                .attr("font-size", "11px")
                                .attr("fill", color(parseInt(data[i].color_ID)));
                        }
                    }
                })
                .on("mouseout", () => {
                    tsne_svg.select("#plot")
                        .selectAll("circle")
                        .attr("r", 4)
                        .attr("fill", d => color(parseInt(d.color_ID)));
                    tsne_svg.select("#text")
                        .selectAll("text")
                        .remove();

                })
                .on("click", d => {
                    d3.select("#middle_thumb")
                        .selectAll("svg")
                        .remove();

                    for (var i = 0; i < data.length; ++i) {
                        var label = data[i].true_label;
                        if (label == d.true_label) {
                            var id = data[i].picture_imageNet_ID;  
 
                            var svg = d3.select("#middle_thumb").append("svg")
                                .attr('id', `SVG_${id}`)
                                .attr("width", "150px")
                                .attr("height", "150px");

                            var svg_img = svg.append('image')
                                .attr('image-rendering', 'optimizeQuality')
                                .attr('x', '0')
                                .attr('y', '0')
                                .attr("preserveAspectRatio", "none")
                                .attr('height', 150)
                                .attr('width', 150)
                                .attr('xlink:href', `new_umap_image/${id}.JPEG`);
      
                        }
                    }

                    d3.select("#right-inner1")
                        .append("button")
                        .attr("id", `button-${d.picture_imageNet_ID}`)
                        .text("delete")
                        .on("click", () => {
                            d3.select(`#heatmap_${d.picture_imageNet_ID}`).remove();
                            d3.select(`#right-inner-${d.picture_imageNet_ID}`).remove();
                            d3.select(`#button-${d.picture_imageNet_ID}`).remove();
                        });

                    d3.select("#right-inner1").append("div")
                        .attr("id", `right-inner-${d.picture_imageNet_ID}`);

                    d3.select("#right-inner1").append("div")
                        .attr("id", `heatmap_${d.picture_imageNet_ID}`)
                        .style("display","flex");

                    var size = 190

                    var svg = d3.select(`#heatmap_${d.picture_imageNet_ID}`).append("svg")
                        .attr('id', `SVG_${d.picture_imageNet_ID}`)
                        .attr("width", size)
                        .attr("height", size);

                    var svg_img = svg.append('image')
                        .attr('image-rendering', 'optimizeQuality')
                        .attr('x', '0')
                        .attr('y', '0')
                        .attr("preserveAspectRatio", "none")
                        .attr('height', size)
                        .attr('width', size)
                        .attr('xlink:href', `new_umap_image/${d.picture_imageNet_ID}.JPEG`);

                    var svg = d3.select(`#heatmap_${d.picture_imageNet_ID}`).append("svg")
                        .attr('id', `SVG_${d.model_1_heatmap_ID}`)
                        .attr("width", size)
                        .attr("height", size);

                    var svg_img = svg.append('image')
                        .attr("preserveAspectRatio", "none")
                        .attr('image-rendering', 'optimizeQuality')
                        .attr('x', '0')
                        .attr('y', '0')
                        .attr('height', size)
                        .attr('width', size)
                        .attr('xlink:href', `img_grad_cam/${d.model_1_heatmap_ID}.JPEG`);

                    var svg = d3.select(`#heatmap_${d.picture_imageNet_ID}`).append("svg")
                        .attr('id', `SVG_${d.model_2_heatmap_ID}`)
                        .attr("width", size)
                        .attr("height", size);

                    var svg_img = svg.append('image')
                        .attr('image-rendering', 'optimizeQuality')
                        .attr("preserveAspectRatio", "none")
                        .attr('x', '0')
                        .attr('y', '0')
                        .attr('height', size)
                        .attr('width', size)
                        .attr('xlink:href', `img_grad_cam/${d.model_2_heatmap_ID}.JPEG`);

                    var svg = d3.select(`#heatmap_${d.picture_imageNet_ID}`).append("svg")
                        .attr('id', `SVG_${d.combine_heatmap_ID}`)
                        .attr("width", size)
                        .attr("height", size)
                        .call(d3.zoom().on("zoom", function () {
                            svg.attr("transform", d3.event.transform)
                        }))
                        .append("g");

                    var svg_img = svg.append('image')
                        .attr('image-rendering', 'optimizeQuality')
                        .attr("preserveAspectRatio", "none")
                        .attr('x', '0')
                        .attr('y', '0')
                        .attr('height', size)
                        .attr('width', size)
                        .attr('xlink:href', `img_grad_cam/${d.combine_heatmap_ID}.JPEG`);

                    

                    d3.select(`#right-inner-${d.picture_imageNet_ID}`)
                        .append("table")
                        .attr("id", `table_${d.picture_imageNet_ID}`)
                        .attr("class", "table table-bordered");

                    var column2 = [{
                        field: 'picture_imageNet_ID',
                        title: 'FigureId',
                    }, {
                        field: 'true_label',
                        title: 'Class',
                    }, {
                        field: 'prop_model_1',
                        title: 'predict1',
                    }, {
                        field: 'prop_model_2',
                        title: 'predict2',
                    }];
                    var data2 = [{
                        picture_imageNet_ID: d.picture_imageNet_ID,
                        true_label: d.true_label,
                        prop_model_1: d.prop_model_1,
                        prop_model_2: d.prop_model_2
                    }];
                    $(`#table_${d.picture_imageNet_ID}`).bootstrapTable({
                        columns: column2,
                        data: data2,
                    });
                });

            function zoomed() {

                var new_x_scale = d3.event.transform.rescaleX(xScale);
                var new_y_scale = d3.event.transform.rescaleY(yScale);

                circles
                    .attr("cx", function (d) {
                        return new_x_scale(parseFloat(d.view_X))
                    })
                    .attr("cy", function (d) {
                        return new_y_scale(parseFloat(d.view_Y))
                    });
            }
        });
       
        var click_row;
        var column1 = [{
            field: 'picture_imageNet_ID',
            title: 'FigureId',
            sortable: true
        }, {
                field: 'true_label',
            title: 'Class',
            sortable: true
        }, {
                field: 'predict_lable_model_1',
            title: 'predict1',
            sortable: true
        }, {
                field: 'predict_lable_model_2',
            title: 'predict2',
            sortable: true
            }];
        $('#table1').bootstrapTable({
            url: 'result_version_1.json',
            toolbar: "#toolbar",
            queryParams: "queryParams",
            pagination: true,
            search: true,
            pageNumber: 1,
            pageSize: 10,
            pageList: [10, 25, 50, 100],
            minimumCountColumns: 2,
            clickToSelect: true,
            columns: column1,
            onSort: function (name, order) {
                $('#table1').bootstrapTable('refreshOptions', {
                    sortName: name,
                    sortOrder: order
                });
            },
            onClickRow: function (row) {
                d3.json("result_version_1.json", function (error, data) {
                    d3.select("#middle_thumb")
                        .selectAll("svg")
                        .remove();

                    for (var i = 0; i < data.length; ++i) {
                        var label = data[i].true_label;
                        if (label == row.true_label) {
                            id = data[i].picture_imageNet_ID;
                            var svg = d3.select("#middle_thumb").append("svg")
                                .attr('id', `SVG_${id}`)
                                .attr("width", "150px")
                                .attr("height", "150px");

                            var svg_img = svg.append('image')
                                .attr('image-rendering', 'optimizeQuality')
                                .attr('x', '0')
                                .attr('y', '0')
                                .attr("preserveAspectRatio", "none")
                                .attr('height', 150)
                                .attr('width', 150)
                                .attr('xlink:href', `new_umap_image/${id}.JPEG`)
                        }
                    }

                    d3.select("#right-inner1")
                        .append("button")
                        .attr("id", `button-${row.picture_imageNet_ID}`)
                        .text("delete")
                        .on("click", () => {
                            d3.select(`#heatmap_${row.picture_imageNet_ID}`).remove();
                            d3.select(`#right-inner-${row.picture_imageNet_ID}`).remove();
                            d3.select(`#button-${row.picture_imageNet_ID}`).remove();
                        });

                    d3.select("#right-inner1").append("div")
                        .attr("id", `right-inner-${row.picture_imageNet_ID}`);

                    d3.select("#right-inner1").append("div")
                        .attr("id", `heatmap_${row.picture_imageNet_ID}`)
                        .style("display", "flex");

                    var size = 190

                    var svg = d3.select(`#heatmap_${row.picture_imageNet_ID}`).append("svg")
                        .attr('id', `SVG_${row.picture_imageNet_ID}`)
                        .attr("width", size)
                        .attr("height", size);

                    var svg_img = svg.append('image')
                        .attr('image-rendering', 'optimizeQuality')
                        .attr('x', '0')
                        .attr('y', '0')
                        .attr("preserveAspectRatio", "none")
                        .attr('height', size)
                        .attr('width', size)
                        .attr('xlink:href', `new_umap_image/${row.picture_imageNet_ID}.JPEG`);

                    var svg = d3.select(`#heatmap_${row.picture_imageNet_ID}`).append("svg")
                        .attr('id', `SVG_${row.model_1_heatmap_ID}`)
                        .attr("width", size)
                        .attr("height", size);

                    var svg_img = svg.append('image')
                        .attr("preserveAspectRatio", "none")
                        .attr('image-rendering', 'optimizeQuality')
                        .attr('x', '0')
                        .attr('y', '0')
                        .attr('height', size)
                        .attr('width', size)
                        .attr('xlink:href', `img_grad_cam/${row.model_1_heatmap_ID}.JPEG`);

                    var svg = d3.select(`#heatmap_${row.picture_imageNet_ID}`).append("svg")
                        .attr('id', `SVG_${row.model_2_heatmap_ID}`)
                        .attr("width", size)
                        .attr("height", size);

                    var svg_img = svg.append('image')
                        .attr('image-rendering', 'optimizeQuality')
                        .attr("preserveAspectRatio", "none")
                        .attr('x', '0')
                        .attr('y', '0')
                        .attr('height', size)
                        .attr('width', size)
                        .attr('xlink:href', `img_grad_cam/${row.model_2_heatmap_ID}.JPEG`);

                    var svg = d3.select(`#heatmap_${row.picture_imageNet_ID}`).append("svg")
                        .attr('id', `SVG_${row.combine_heatmap_ID}`)
                        .attr("width", size)
                        .attr("height", size);

                    var svg_img = svg.append('image')
                        .attr('image-rendering', 'optimizeQuality')
                        .attr("preserveAspectRatio", "none")
                        .attr('x', '0')
                        .attr('y', '0')
                        .attr('height', size)
                        .attr('width', size)
                        .attr('xlink:href', `img_grad_cam/${row.combine_heatmap_ID}.JPEG`);

                    d3.select(`#right-inner-${row.picture_imageNet_ID}`)
                        .append("table")
                        .attr("id", `table_${row.picture_imageNet_ID}`)
                        .attr("class", "table table-bordered");

                    var column3 = [{
                        field: 'picture_imageNet_ID',
                        title: 'FigureId',
                    }, {
                        field: 'true_label',
                        title: 'Class',
                    }, {
                        field: 'prop_model_1',
                        title: 'predict1',
                    }, {
                        field: 'prop_model_2',
                        title: 'predict2',
                    }];
                    var data3 = [{
                        picture_imageNet_ID: row.picture_imageNet_ID,
                        true_label: row.true_label,
                        prop_model_1: row.prop_model_1,
                        prop_model_2: row.prop_model_2
                    }];
                    $(`#table_${row.picture_imageNet_ID}`).bootstrapTable({
                        columns: column3,
                        data: data3,
                    });
                });
            },
            
        });
        function reset() {
            $('#table1').bootstrapTable('refresh');
        };
        
    </script>
</body>
</html>
